---

- name: "MEDIUM | RHEL-09-255010 | PATCH | All RHEL 9 networked systems must have SSH installed."
  when:
    - rhel_09_255010
    - rhel9stig_sshd_required
  tags:
    - RHEL-09-255010
    - CAT2
    - CCI-002418
    - CCI-002420
    - CCI-002421
    - CCI-002422
    - SRG-OS-000423-GPOS-00187
    - SRG-OS-000424-GPOS-00188
    - SRG-OS-000425-GPOS-00189
    - SRG-OS-000426-GPOS-00190
    - SV-257978r1045013_rule
    - V-257978
    - NIST800-53R4_SC-8
  ansible.builtin.package:
    name: openssh-server
    state: present

- name: "MEDIUM | RHEL-09-255015 | PATCH | All RHEL 9 networked systems must have and implement SSH to protect the confidentiality and integrity of transmitted and received information, as well as information during preparation for transmission."
  when:
    - rhel_09_255015
    - rhel9stig_sshd_required
  tags:
    - RHEL-09-255015
    - CAT2
    - CCI-002418
    - CCI-002420
    - CCI-002421
    - CCI-002422
    - SRG-OS-000423-GPOS-00187
    - SRG-OS-000424-GPOS-00188
    - SRG-OS-000425-GPOS-00189
    - SV-257979r958908_rule
    - V-257979
    - NIST800-53R4_SC-8
  ansible.builtin.systemd:
    name: sshd
    enabled: true
    state: started

- name: "MEDIUM | RHEL-09-255020 | PATCH | RHEL 9 must have the openssh-clients package installed"
  when:
    - rhel_09_255020
    - rhel9stig_sshd_required
  tags:
    - RHEL-09-255020
    - CAT2
    - CCI-000366
    - SRG-OS-000480-GPOS-00227
    - SV-257980r1045016_rule
    - V-257980
    - NIST800-53R4_SC-8
  ansible.builtin.package:
    name: openssh-clients
    state: present

- name: "MEDIUM | RHEL-09-255025 | PATCH | RHEL 9 must display the Standard Mandatory DOD Notice and Consent Banner before granting local or remote access to the system via a SSH logon."
  when:
    - rhel_09_255025
    - rhel9stig_sshd_required
  tags:
    - RHEL-09-255025
    - CAT2
    - CCI-000048
    - CCI-001384
    - CCI-001385
    - CCI-001386
    - CCI-001387
    - CCI-001388
    - SRG-OS-000023-GPOS-00006
    - SRG-OS-000228-GPOS-00088
    - SV-257981r1045019_rule
    - V-257981
    - NIST800-53R4_AC-8
    - ssh
  notify: Restart_sshd
  block:
    - name: "MEDIUM | RHEL-09-255025 | PATCH | RHEL 9 must display the Standard Mandatory DOD Notice and Consent Banner before granting local or remote access to the system via a SSH logon. | Remove"
      when: "item.path != rhel9stig_sshd_config_file"
      ansible.builtin.replace:
        path: "{{ item }}"
        regexp: (?i)(^banner.*)
        replace: '#\1'
      failed_when: discovered_banner_exists.rc != 257
      register: discovered_banner_exists
      loop: "{{ prelim_sshd_config_files.files }}"

    - name: "MEDIUM | RHEL-09-255025 | PATCH | RHEL 9 must display the Standard Mandatory DOD Notice and Consent Banner before granting local or remote access to the system via a SSH logon. | Remove"
      ansible.builtin.lineinfile:
        path: "{{ rhel9stig_sshd_config_file }}"
        regexp: (?i)^(#|)\s*banner .*
        line: "banner {{ rhel9stig_sshd_config.banner_file }}"
        validate: sshd -t -f %s

- name: "MEDIUM | RHEL-09-255030 | PATCH | RHEL 9 must log SSH connection attempts and failures to the server."
  when:
    - rhel_09_255030
    - rhel9stig_sshd_required
  tags:
    - RHEL-09-255030
    - CAT2
    - CCI-000067
    - SRG-OS-000032-GPOS-00013
    - SV-257982r1045021_rule
    - V-257982
    - NIST800-53R4_AC-17
    - ssh
  notify: Restart_sshd
  block:
    - name: "MEDIUM | RHEL-09-255030 | PATCH | RHEL 9 must log SSH connection attempts and failures to the server. | Remove"
      when: "item.path != rhel9stig_sshd_config_file"
      ansible.builtin.replace:
        path: "{{ item }}"
        regexp: (?i)(^LogLevel.*)
        replace: '#\1'
      failed_when: discovered_loglevel_exists.rc != 257
      register: discovered_loglevel_exists
      loop: "{{ prelim_sshd_config_files.files }}"

    - name: "MEDIUM | RHEL-09-255030 | PATCH | RHEL 9 must log SSH connection attempts and failures to the server. | Exists"
      ansible.builtin.lineinfile:
        path: "{{ rhel9stig_sshd_config_file }}"
        regexp: (?i)^(#|)\s*LogLevel.*
        line: "LogLevel {{ rhel9stig_sshd_config.loglevel }}"
        validate: sshd -t -f %s

- name: "MEDIUM | RHEL-09-255035 | PATCH | RHEL 9 SSHD must accept public key authentication"
  when:
    - rhel_09_255035
    - rhel9stig_sshd_required
  tags:
    - RHEL-09-255035
    - CAT2
    - CCI-000765
    - CCI-000766
    - CCI-000767
    - CCI-000768
    - SRG-OS-000105-GPOS-00052
    - SRG-OS-000106-GPOS-00053
    - SRG-OS-000107-GPOS-00054
    - SRG-OS-000108-GPOS-00055
    - SV-257983r1015084_rule
    - V-257983
    - NIST800-53R4_IA-2
    - ssh
  notify: Restart_sshd
  block:
    - name: "MEDIUM | RHEL-09-255035 | PATCH | RHEL 9 SSHD must accept public key authentication | Remove"
      when: "item.path != rhel9stig_sshd_config_file"
      ansible.builtin.replace:
        path: "{{ item }}"
        regexp: (?i)(^PubkeyAuthentication.*)
        replace: '#\1'
      failed_when: discovered_pubkey_exists.rc != 257
      register: discovered_pubkey_exists
      loop: "{{ prelim_sshd_config_files.files }}"

    - name: "MEDIUM | RHEL-09-255035 | PATCH | RHEL 9 SSHD must accept public key authentication | Exists"
      ansible.builtin.lineinfile:
        path: "{{ rhel9stig_sshd_config_file }}"
        regexp: (?i)^(#|)\s*PubkeyAuthentication\s*(yes|no|true|false)
        line: "PubkeyAuthentication {{ rhel9stig_sshd_config.pubkeyauth }}"
        validate: sshd -t -f %s

- name: "MEDIUM | RHEL-09-255045 | PATCH | RHEL 9 must not permit direct logons to the root account using remote access via SSH."
  when:
    - rhel_09_255045
    - rhel9stig_sshd_required
  tags:
    - RHEL-09-255045
    - CAT2
    - CCI-000770
    - SRG-OS-000109-GPOS-00056
    - SRG-OS-000480-GPOS-00227
    - SV-257985r1045028_rule
    - V-257985
    - NIST800-53R4_IA-2
    - ssh
  notify: Restart_sshd
  block:
    - name: "MEDIUM | RHEL-09-255045 | PATCH | RHEL 9 must not permit direct logons to the root account using remote access via SSH. | Remove existing"
      when: "item.path != rhel9stig_sshd_config_file"
      ansible.builtin.replace:
        path: "{{ item }}"
        regexp: (?i)(^PermitRootLogin.*)
        replace: '#\1'
      failed_when: discovered_rootlogin_exists.rc != 257
      register: discovered_rootlogin_exists
      loop: "{{ prelim_sshd_config_files.files }}"

    - name: "MEDIUM | RHEL-09-255045 | PATCH | RHEL 9 must not permit direct logons to the root account using remote access via SSH. | Remove existing"
      ansible.builtin.lineinfile:
        path: "{{ rhel9stig_sshd_config_file }}"
        regexp: (?i)^(#|)\s*PermitRootLogin\s*(yes|no|true|false)
        line: "PermitRootLogin {{ rhel9stig_sshd_config.permitroot }}"
        validate: sshd -t -f %s

- name: "MEDIUM | RHEL-09-255055 | PATCH | RHEL 9 SSH daemon must be configured to use system-wide crypto policies."
  when:
    - rhel_09_255055
    - rhel9stig_sshd_required
  tags:
    - RHEL-09-255055
    - CAT2
    - CCI-001453
    - SRG-OS-000250-GPOS-00093
    - SV-257987r1014852_rule
    - V-257987
    - NIST800-53R4_AC-17
    - ssh
  notify: Restart_sshd
  block:
    - name: "MEDIUM | RHEL-09-255055 | PATCH | RHEL 9 SSH daemon must be configured to use system-wide crypto policies. | Remove existing"
      when: "item.path != rhel9stig_sshd_config_file"
      ansible.builtin.replace:
        path: "{{ item }}"
        regexp: (?i)^Include.*(?!etc\/crypto-policies\/back-ends\/opensshserver\.config)
        replace: '#\1'
      failed_when: discovered_sshinclude_exists.rc != 257
      register: discovered_sshinclude_exists
      loop: "{{ prelim_sshd_config_files.files }}"

    - name: "MEDIUM | RHEL-09-255055 | PATCH | RHEL 9 SSH daemon must be configured to use system-wide crypto policies. | Esnure exists"
      ansible.builtin.lineinfile:
        path: "{{ rhel9stig_sshd_config_file }}"
        regexp: (?i)^(#|)\s*Include.*
        line: "Include {{ rhel9stig_sshd_config.include_conf }}"
        validate: sshd -t -f %s

- name: "MEDIUM | RHEL-09-255060 | PATCH | RHEL 9 must implement DOD-approved encryption ciphers to protect the confidentiality of SSH client connections."
  when:
    - rhel_09_255060
    - rhel9stig_sshd_required
  tags:
    - RHEL-09-255060
    - CAT2
    - CCI-001453
    - SRG-OS-000250-GPOS-00093
    - SV-257988r1051234_rule
    - V-257988
    - NIST800-53R4_AC-17
    - ssh
  notify: Restart_sshd
  ansible.builtin.lineinfile:
    path: "{{ rhel9stig_sshd_config_file }}"
    regexp: (?i)^(#|)\s*Include.*
    line: "Include {{ rhel9stig_sshd_config.include_conf }}"
    create: true
    mode: 'go-rwx'
    validate: sshd -t -f %s

- name: "MEDIUM | RHEL-09-255064 | PATCH | The RHEL 9 SSH client must be configured to use only DOD-approved encryption ciphers employing FIPS 140-3 validated cryptographic hash algorithms to protect the confidentiality of SSH client connections."
  when:
    - rhel_09_255064
    - rhel9stig_sshd_required
  tags:
    - RHEL-09-255064
    - CAT2
    - CCI-001453
    - SRG-OS-000250-GPOS-00093
    - SV-270177r1051237_rule
    - V-270177
    - NIST800-53R4_AC-17
  vars:
    warn_control_id: "MEDIUM | RHEL-09-255064"
  block:
    - name: "MEDIUM | RHEL-09-255064 | AUDIT | The RHEL 9 SSH client must be configured to use only DOD-approved encryption ciphers employing FIPS 140-3 validated cryptographic hash algorithms to protect the confidentiality of SSH client connections. | capture current"
      ansible.builtin.command: grep -i Ciphers /etc/crypto-policies/back-ends/openssh.config
      changed_when: false
      register: discovered_openssh_ciphers

    - name: "MEDIUM | RHEL-09-255064 | PATCH | The RHEL 9 SSH client must be configured to use only DOD-approved encryption ciphers employing FIPS 140-3 validated cryptographic hash algorithms to protect the confidentiality of SSH client connections. | Correct if wrong"
      when:
        - rhel9stig_disruption_high
        - "(rhel9stig_dod_ciphers | join (',')) not in discovered_openssh_ciphers.stdout"
      ansible.builtin.debug:
        msg: "Crypto policies being reinstalled as handler"
      notify: Reinstall_crypto_policies

    - name: "MEDIUM | RHEL-09-255064 | WARN | The RHEL 9 SSH client must be configured to use only DOD-approved encryption ciphers employing FIPS 140-3 validated cryptographic hash algorithms to protect the confidentiality of SSH client connections."
      when:
        - not rhel9stig_disruption_high
        - "(rhel9stig_dod_ciphers | join (',')) not in discovered_openssh_ciphers.stdout"
      ansible.builtin.debug:
        msg: "Warning!! Investigate /etc/crypto-policies/back-ends/openssh.config for correct IPS 140-3 ciphers and order"

    - name: "MEDIUM | RHEL-09-255064 | WARN | The RHEL 9 SSH client must be configured to use only DOD-approved encryption ciphers employing FIPS 140-3 validated cryptographic hash algorithms to protect the confidentiality of SSH client connections."
      when:
        - not rhel9stig_disruption_high
        - "(rhel9stig_dod_ciphers | join (',')) not in discovered_openssh_ciphers.stdout"
      ansible.builtin.import_tasks:
        file: warning_facts.yml

- name: "MEDIUM | RHEL-09-255065 | PATCH | The RHEL 9 SSH server must be configured to use only DOD-approved encryption ciphers employing FIPS 140-3 validated cryptographic hash algorithms to protect the confidentiality of SSH client connections."
  when:
    - rhel_09_255065
    - rhel9stig_sshd_required
  tags:
    - RHEL-09-255065
    - CAT2
    - CCI-001453
    - SRG-OS-000250-GPOS-00093
    - SV-270177r1051237_rule
    - V-270177
    - NIST800-53R4_AC-17
  vars:
    warn_control_id: "MEDIUM | RHEL-09-255065"
  block:
    - name: "MEDIUM | RHEL-09-255065 | AUDIT | The RHEL 9 SSH server must be configured to use only DOD-approved encryption ciphers employing FIPS 140-3 validated cryptographic hash algorithms to protect the confidentiality of SSH client connections. | capture current"
      ansible.builtin.command: grep -i Ciphers /etc/crypto-policies/back-ends/opensshserver.config
      changed_when: false
      register: discovered_openssh_server_ciphers

    - name: "MEDIUM | RHEL-09-255065 | PATCH | The RHEL 9 SSH server must be configured to use only DOD-approved encryption ciphers employing FIPS 140-3 validated cryptographic hash algorithms to protect the confidentiality of SSH client connections. | Correct if wrong"
      when:
        - rhel9stig_disruption_high
        - "(rhel9stig_dod_ciphers | join (',')) not in discovered_openssh_server_ciphers.stdout"
      ansible.builtin.debug:
        msg: "Crypto policies being reinstalled as handler"
      notify: Reinstall_crypto_policies

    - name: "MEDIUM | RHEL-09-255065 | WARN | The RHEL 9 SSH server must be configured to use only DOD-approved encryption ciphers employing FIPS 140-3 validated cryptographic hash algorithms to protect the confidentiality of SSH client connections."
      when:
        - not rhel9stig_disruption_high
        - "(rhel9stig_dod_ciphers | join (',')) not in discovered_openssh_server_ciphers.stdout"
      ansible.builtin.debug:
        msg: "Warning!! Investigate /etc/crypto-policies/back-ends/openssh.config for correct IPS 140-3 ciphers and order"

    - name: "MEDIUM | RHEL-09-255065 | WARN | The RHEL 9 SSH server must be configured to use only DOD-approved encryption ciphers employing FIPS 140-3 validated cryptographic hash algorithms to protect the confidentiality of SSH client connections."
      when:
        - not rhel9stig_disruption_high
        - "(rhel9stig_dod_ciphers | join (',')) not in discovered_openssh_server_ciphers.stdout"
      ansible.builtin.import_tasks:
        file: warning_facts.yml

- name: "MEDIUM | RHEL-09-255070 | PATCH | The RHEL 9 SSH client must be configured to use only DOD-approved Message Authentication Codes (MACs) employing FIPS 140-3 validated cryptographic hash algorithms to protect the confidentiality of SSH client connections."
  when:
    - rhel_09_255070
    - rhel9stig_sshd_required
  tags:
    - RHEL-09-255070
    - CAT2
    - CCI-001453
    - SRG-OS-000250-GPOS-00093
    - SV-270178r1051243_rule
    - V-270178
    - NIST800-53R4_AC-17
  vars:
    warn_control_id: "MEDIUM | RHEL-09-255070"
  block:
    - name: "MEDIUM | RHEL-09-255070 | AUDIT | The RHEL 9 SSH client must be configured to use only DOD-approved Message Authentication Codes (MACs) employing FIPS 140-3 validated cryptographic hash algorithms to protect the confidentiality of SSH client connections. | capture current"
      ansible.builtin.command: grep -i MACs /etc/crypto-policies/back-ends/openssh.config
      changed_when: false
      register: discovered_openssh_macs

    - name: "MEDIUM | RHEL-09-255070 | PATCH | The RHEL 9 SSH client must be configured to use only DOD-approved Message Authentication Codes (MACs) employing FIPS 140-3 validated cryptographic hash algorithms to protect the confidentiality of SSH client connections. | Correct if wrong"
      when:
        - rhel9stig_disruption_high
        - "(rhel9stig_dod_macs | join (',')) not in discovered_openssh_macs.stdout"
      ansible.builtin.debug:
        msg: "Crypto policies being reinstalled as handler"
      notify: Reinstall_crypto_policies

    - name: "MEDIUM | RHEL-09-255070 | WARN | The RHEL 9 SSH client must be configured to use only DOD-approved Message Authentication Codes (MACs) employing FIPS 140-3 validated cryptographic hash algorithms to protect the confidentiality of SSH client connections."
      when:
        - not rhel9stig_disruption_high
        - "(rhel9stig_dod_macs | join (',')) not in discovered_openssh_macs.stdout"
      ansible.builtin.debug:
        msg: "Warning!! Investigate /etc/crypto-policies/back-ends/openssh.config for correct IPS 140-3 MACs and order"

    - name: "MEDIUM | RHEL-09-255070 | WARN | The RHEL 9 SSH client must be configured to use only DOD-approved Message Authentication Codes (MACs) employing FIPS 140-3 validated cryptographic hash algorithms to protect the confidentiality of SSH client connections."
      when:
        - not rhel9stig_disruption_high
        - "(rhel9stig_dod_macs | join (',')) not in discovered_openssh_macs.stdout"
      ansible.builtin.import_tasks:
        file: warning_facts.yml

- name: "MEDIUM | RHEL-09-255075 | PATCH | The RHEL 9 SSH server must be configured to use only DOD-approved Message Authentication Codes (MACs) employing FIPS 140-3 validated cryptographic hash algorithms to protect the confidentiality of SSH client connections."
  when:
    - rhel_09_255075
    - rhel9stig_sshd_required
  tags:
    - RHEL-09-255075
    - CAT2
    - CCI-001453
    - SRG-OS-000250-GPOS-00093
    - SV-257991r1051246_rule
    - V-257991
    - NIST800-53R4_AC-17
  vars:
    warn_control_id: "MEDIUM | RHEL-09-255075"
  block:
    - name: "MEDIUM | RHEL-09-255075 | AUDIT | The RHEL 9 SSH server must be configured to use only DOD-approved Message Authentication Codes (MACs) employing FIPS 140-3 validated cryptographic hash algorithms to protect the confidentiality of SSH client connections. | capture current"
      ansible.builtin.command: grep -i MACs /etc/crypto-policies/back-ends/opensshserver.config
      changed_when: false
      register: discovered_openssh_server_macs

    - name: "MEDIUM | RHEL-09-255075 | PATCH | The RHEL 9 SSH server must be configured to use only DOD-approved Message Authentication Codes (MACs) employing FIPS 140-3 validated cryptographic hash algorithms to protect the confidentiality of SSH client connections. | Correct if wrong"
      when:
        - rhel9stig_disruption_high
        - "(rhel9stig_dod_macs | join (',')) not in discovered_openssh_server_macs.stdout"
      ansible.builtin.debug:
        msg: "Crypto policies being reinstalled as handler"
      notify: Reinstall_crypto_policies

    - name: "MEDIUM | RHEL-09-255075 | WARN | The RHEL 9 SSH server must be configured to use only DOD-approved Message Authentication Codes (MACs) employing FIPS 140-3 validated cryptographic hash algorithms to protect the confidentiality of SSH client connections."
      when:
        - not rhel9stig_disruption_high
        - "(rhel9stig_dod_macs | join (',')) not in discovered_openssh_server_macs.stdout"
      ansible.builtin.debug:
        msg: "Warning!! Investigate /etc/crypto-policies/back-ends/openssh.config for correct IPS 140-3 MACs and order"

    - name: "MEDIUM | RHEL-09-255075 | WARN | The RHEL 9 SSH server must be configured to use only DOD-approved Message Authentication Codes (MACs) employing FIPS 140-3 validated cryptographic hash algorithms to protect the confidentiality of SSH client connections."
      when:
        - not rhel9stig_disruption_high
        - "(rhel9stig_dod_macs | join (',')) not in discovered_openssh_server_macs.stdout"
      ansible.builtin.import_tasks:
        file: warning_facts.yml

- name: "MEDIUM | RHEL-09-255080 | PATCH | RHEL 9 must not allow a noncertificate trusted host SSH logon to the system."
  when:
    - rhel_09_255080
    - rhel9stig_sshd_required
  tags:
    - RHEL-09-255080
    - CAT2
    - CCI-000366
    - SRG-OS-000480-GPOS-00229
    - SV-257992r1045047_rule
    - V-257992
    - NIST800-53R4_CM-6
    - ssh
  notify: Restart_sshd
  block:
    - name: "MEDIUM | RHEL-09-255080 | PATCH | RHEL 9 must not allow a noncertificate trusted host SSH logon to the system. | Remove"
      when: "item.path != rhel9stig_sshd_config_file"
      ansible.builtin.replace:
        path: "{{ item }}"
        regexp: (?i)^(HostbasedAuthentication.*)
        replace: '#\1'
      failed_when: discovered_hostbasedauth_exists.rc != 257
      register: discovered_hostbasedauth_exists
      loop: "{{ prelim_sshd_config_files.files }}"

    - name: "MEDIUM | RHEL-09-255080 | PATCH | RHEL 9 must not allow a noncertificate trusted host SSH logon to the system. | Exists"
      ansible.builtin.lineinfile:
        path: "{{ rhel9stig_sshd_config_file }}"
        regexp: (?i)^(#|)\s*HostbasedAuthentication\s*(yes|no|true|false)
        line: "HostbasedAuthentication {{ rhel9stig_sshd_config.hostauth }}"
        create: true
        mode: 'go-rwx'
        validate: sshd -t -f %s

- name: "MEDIUM | RHEL-09-255085 | PATCH | RHEL 9 must not allow users to override SSH environment variables."
  when:
    - rhel_09_255085
    - rhel9stig_sshd_required
  tags:
    - RHEL-09-255085
    - CAT2
    - CCI-000366
    - SRG-OS-000480-GPOS-00229
    - SV-257993r1045049_rule
    - V-257993
    - NIST800-53R4_CM-6
    - ssh
  notify: Restart_sshd
  block:
    - name: "MEDIUM | RHEL-09-255085 | PATCH | RHEL 9 must not allow users to override SSH environment variables. | Remove"
      when: "item.path != rhel9stig_sshd_config_file"
      ansible.builtin.replace:
        path: "{{ item }}"
        regexp: (?i)^(PermitUserEnvironment.*)
        replace: '#\1'
      failed_when: discovered_userenv_exists.rc != 257
      register: discovered_userenv_exists
      loop: "{{ prelim_sshd_config_files.files }}"

    - name: "MEDIUM | RHEL-09-255085 | PATCH | RHEL 9 must not allow users to override SSH environment variables. | Exists"
      ansible.builtin.lineinfile:
        path: "{{ rhel9stig_sshd_config_file }}"
        regexp: (?i)^(#|)\s*PermitUserEnvironment\s*(yes|no)
        line: "PermitUserEnvironment {{ rhel9stig_sshd_config.userenv }}"
        create: true
        mode: 'go-rwx'
        validate: sshd -t -f %s

- name: "MEDIUM | RHEL-09-255090 | PATCH | RHEL 9 must force a frequent session key renegotiation for SSH connections to the server."
  when:
    - rhel_09_255090
    - rhel9stig_sshd_required
  tags:
    - RHEL-09-255090
    - CAT2
    - CCI-000068
    - CCI-002418
    - CCI-002421
    - SRG-OS-000423-GPOS-00187
    - SRG-OS-000033-GPOS-00014
    - SRG-OS-000424-GPOS-00188
    - SV-257994r1045051_rule
    - V-257994
    - NIST800-53R4_AC-17
    - NIST800-53R4_SC-8
    - ssh
  notify: Restart_sshd
  block:
    - name: "MEDIUM | RHEL-09-255090 | PATCH | RHEL 9 must force a frequent session key renegotiation for SSH connections to the server. | Remove"
      when: "item.path != rhel9stig_sshd_config_file"
      ansible.builtin.replace:
        path: "{{ item }}"
        regexp: (?i)(^RekeyLimit.*)
        replace: '#\1'
      failed_when: discovered_rekey_exists.rc != 257
      register: discovered_rekey_exists
      loop: "{{ prelim_sshd_config_files.files }}"

    - name: "MEDIUM | RHEL-09-255090 | PATCH | RHEL 9 must force a frequent session key renegotiation for SSH connections to the server. | Exists"
      ansible.builtin.lineinfile:
        path: "{{ rhel9stig_sshd_config_file }}"
        regexp: (?i)^(#|)\s*RekeyLimit.*
        line: "RekeyLimit {{ rhel9stig_sshd_config.rekeylimit }}"
        create: true
        mode: 'go-rwx'
        validate: sshd -t -f %s

- name: "MEDIUM | RHEL-09-255095 | PATCH | RHEL 9 must be configured so that all network connections associated with SSH traffic terminate after becoming unresponsive."
  when:
    - rhel_09_255095
    - rhel9stig_sshd_required
  tags:
    - RHEL-09-255095
    - CAT2
    - CCI-001133
    - CCI-002361
    - SRG-OS-000163-GPOS-00072
    - SRG-OS-000279-GPOS-00109
    - SV-257995r1045053_rule
    - V-257995
    - NIST800-53R4_SC-10
    - NIST800-53R4_AC-12
    - ssh
  notify: Restart_sshd
  block:
    - name: "MEDIUM | RHEL-09-255095 | PATCH | RHEL 9 must be configured so that all network connections associated with SSH traffic terminate after becoming unresponsive. | Remove"
      when: "item.path != rhel9stig_sshd_config_file"
      ansible.builtin.replace:
        path: "{{ item }}"
        regexp: (?i)^(ClientAliveCountMax .*)
        replace: '#\1'
      failed_when: discovered_alivecount_exists.rc != 257
      register: discovered_alivecount_exists
      loop: "{{ prelim_sshd_config_files.files }}"

    - name: "MEDIUM | RHEL-09-255095 | PATCH | RHEL 9 must be configured so that all network connections associated with SSH traffic terminate after becoming unresponsive. | exists"
      ansible.builtin.lineinfile:
        path: "{{ rhel9stig_sshd_config_file }}"
        regexp: (?i)^(#|)\s*ClientAliveCountMax\s\d*
        line: "ClientAliveCountMax {{ rhel9stig_sshd_config.clientalivecountmax }}"
        create: true
        mode: 'go-rwx'
        validate: sshd -t -f %s

- name: "MEDIUM | RHEL-09-255100 | PATCH | RHEL 9 must be configured so that all network connections associated with SSH traffic are terminated after 10 minutes of becoming unresponsive."
  when:
    - rhel_09_255100
    - rhel9stig_sshd_required
  tags:
    - RHEL-09-255100
    - CAT2
    - CCI-001133
    - CCI-002361
    - CCI-002891
    - SRG-OS-000126-GPOS-00066
    - SRG-OS-000163-GPOS-00072
    - SRG-OS-000279-GPOS-00109
    - SRG-OS-000395-GPOS-00175
    - SV-257996r1045055_rule
    - V-257996
    - NIST800-53R4_MA-4
    - NIST800-53R4_SC-10
    - NIST800-53R4_AC-12
    - ssh
  notify: Restart_sshd
  block:
    - name: "MEDIUM | RHEL-09-255100 | PATCH | RHEL 9 must be configured so that all network connections associated with SSH traffic are terminated after 10 minutes of becoming unresponsive. | Remove"
      when: "item.path != rhel9stig_sshd_config_file"
      ansible.builtin.replace:
        path: "{{ item }}"
        regexp: (?i)^(ClientAliveInterval.*)
        replace: '#\1'
      failed_when: discovered_liveinterval_exists.rc != 257
      register: discovered_liveinterval_exists
      loop: "{{ prelim_sshd_config_files.files }}"

    - name: "MEDIUM | RHEL-09-255100 | PATCH | RHEL 9 must be configured so that all network connections associated with SSH traffic are terminated after 10 minutes of becoming unresponsive."
      ansible.builtin.lineinfile:
        path: "{{ rhel9stig_sshd_config_file }}"
        regexp: (?i)^(#|)\s*ClientAliveInterval\s\d*
        line: "ClientAliveInterval {{ rhel9stig_sshd_config.clientaliveinterval }}"
        create: true
        mode: 'go-rwx'
        validate: sshd -t -f %s

- name: "MEDIUM | RHEL-09-255105 | PATCH | RHEL 9 SSH server configuration file must be group-owned by root."
  when:
    - rhel_09_255105
    - rhel9stig_sshd_required
  tags:
    - RHEL-09-255105
    - CAT2
    - CCI-000366
    - SRG-OS-000480-GPOS-00227
    - SV-257997r1045057_rule
    - V-257997
    - NIST800-53R4_CM-6
    - ssh
  ansible.builtin.file:
    path: "{{ rhel9stig_sshd_config_file }}"
    group: root
    mode: 'go-rwx'

- name: "MEDIUM | RHEL-09-255110 | PATCH | RHEL 9 SSH server configuration file must be owned by root."
  when:
    - rhel_09_255110
    - rhel9stig_sshd_required
  tags:
    - RHEL-09-255110
    - CAT2
    - CCI-000366
    - SRG-OS-000480-GPOS-00227
    - SV-257998r1045059_rule
    - V-257998
    - NIST800-53R4_CM-6
    - ssh
  ansible.builtin.file:
    path: "{{ rhel9stig_sshd_config_file }}"
    owner: root
    mode: 'go-rwx'

- name: "MEDIUM | RHEL-09-255115 | PATCH | RHEL 9 SSH server configuration file must have mode 0600 or less permissive"
  when:
    - rhel_09_255115
    - rhel9stig_sshd_required
  tags:
    - RHEL-09-255115
    - CAT2
    - CCI-000366
    - SRG-OS-000480-GPOS-00227
    - SV-257999r1045061_rule
    - V-257999
    - NIST800-53R4_CM-6
    - ssh
  block:
    - name: "MEDIUM | RHEL-09-255115 | AUDIT | RHEL 9 SSH server configuration file must have mode 0600 or less permissive | capture files"
      ansible.builtin.find:
        path: /etc/ssh/sshd_config.d
        pattern: '*.pub'
      register: discovered_sshd_configs

    - name: "MEDIUM | RHEL-09-255115 | AUDIT | RHEL 9 SSH server configuration file must have mode 0600 or less permissive | adjust files"
      ansible.builtin.file:
        path: "{{ rhel9stig_sshd_config_file }}"
        mode: 'u-x,go-rwx'

    - name: "MEDIUM | RHEL-09-255115 | AUDIT | RHEL 9 SSH server configuration file must have mode 0600 or less permissive | adjust files"
      when: discovered_sshd_configs.matched > 0
      ansible.builtin.file:
        path: "{{ item.path }}"
        mode: 'u-x,go-rwx'
      loop: "{{ discovered_sshd_configs.files }}"

- name: "MEDIUM | RHEL-09-255120 | PATCH | RHEL 9 SSH private host key files must have mode 0640 or less permissive."
  when:
    - rhel_09_255120
    - rhel9stig_sshd_required
  tags:
    - RHEL-09-255120
    - CAT2
    - CCI-000366
    - SRG-OS-000480-GPOS-00227
    - SV-258000r1045063_rule
    - V-258000
    - NIST800-53R4_CM-6
  block:
    - name: "MEDIUM | RHEL-09-255120 | AUDIT | RHEL 9 SSH private host key files must have mode 0640 or less permissive."
      ansible.builtin.find:
        path: /etc/ssh/
        pattern: '*_key'
      register: discovered_private_ssh_keys

    - name: "MEDIUM | RHEL-09-255120 | PATCH | RHEL 9 SSH private host key files must have mode 0640 or less permissive."
      ansible.builtin.file:
        path: "{{ item.path }}"
        mode: 'u-x,go-rwx'
      loop: "{{ discovered_private_ssh_keys.files }}"

- name: "MEDIUM | RHEL-09-255125 | PATCH | RHEL 9 SSH public host key files must have mode 0644 or less permissive."
  when:
    - rhel_09_255125
    - rhel9stig_sshd_required
  tags:
    - RHEL-09-255125
    - CAT2
    - CCI-000366
    - SRG-OS-000480-GPOS-00227
    - SV-258001r991589_rule
    - V-258001
    - NIST800-53R4_CM-6
  block:
    - name: "MEDIUM | RHEL-09-255125 | AUDIT | RHEL 9 SSH public host key files must have mode 0644 or less permissive."
      ansible.builtin.find:
        path: /etc/ssh
        pattern: '*.pub'
      register: discovered_pub_ssh_keys

    - name: "MEDIUM | RHEL-09-255125 | PATCH | RHEL 9 SSH public host key files must have mode 0644 or less permissive."
      ansible.builtin.file:
        path: "{{ item.path }}"
        mode: 'u-x,go-wx'
      loop: "{{ discovered_pub_ssh_keys.files }}"

- name: "MEDIUM | RHEL-09-255130 | PATCH | RHEL 9 SSH daemon must not allow compression or must only allow compression after successful authentication."
  when:
    - rhel_09_255130
    - rhel9stig_sshd_required
  tags:
    - RHEL-09-255130
    - CAT2
    - CCI-000366
    - SRG-OS-000480-GPOS-00227
    - SV-258002r991589_rule
    - V-258002
    - NIST800-53R4_CM-6
    - ssh
  notify: Restart_sshd
  block:
    - name: "MEDIUM | RHEL-09-255130 | PATCH | RHEL 9 SSH daemon must not allow compression or must only allow compression after successful authentication. | Remove"
      when: "item.path != rhel9stig_sshd_config_file"
      ansible.builtin.replace:
        path: "{{ item }}"
        regexp: (?i)^(compression .*)
        replace: '#\1'
      failed_when: discovered_compression_exists.rc != 257
      register: discovered_compression_exists
      loop: "{{ prelim_sshd_config_files.files }}"

    - name: "MEDIUM | RHEL-09-255130 | PATCH | RHEL 9 SSH daemon must not allow compression or must only allow compression after successful authentication. | Exists in correct file"
      ansible.builtin.lineinfile:
        path: "{{ rhel9stig_sshd_config_file }}"
        regexp: (?i)^(#|)\s*Compression\s*(yes|no|true|false)
        line: "Compression {{ rhel9stig_sshd_config.compress }}"
        validate: sshd -t -f %s

- name: "MEDIUM | RHEL-09-255135 | PATCH | RHEL 9 SSH daemon must not allow GSSAPI authentication."
  when:
    - rhel_09_255135
    - rhel9stig_sshd_required
  tags:
    - RHEL-09-255135
    - CAT2
    - CCI-001813
    - SRG-OS-000364-GPOS-00151
    - SRG-OS-000480-GPOS-00227
    - SV-258003r1045065_rule
    - V-258003
    - NIST800-53R4_CM-5
    - ssh
  notify: Restart_sshd
  block:
    - name: "MEDIUM | RHEL-09-255135 | PATCH | RHEL 9 SSH daemon must not allow GSSAPI authentication. | Remove"
      when: "item.path != rhel9stig_sshd_config_file"
      ansible.builtin.replace:
        path: "{{ item.path }}"
        regexp: (?i)^(GSSAPIAuthentication (yes|true))
        replace: '#\1'
      loop: "{{ prelim_sshd_config_files.files }}"

    - name: "MEDIUM | RHEL-09-255135 | PATCH | RHEL 9 SSH daemon must not allow GSSAPI authentication. | Exists"
      ansible.builtin.lineinfile:
        path: "{{ rhel9stig_sshd_config_file }}"
        regexp: (?i)^(#|)\s*GSSAPIAuthentication\s*(yes|no)
        line: "GSSAPIAuthentication {{ rhel9stig_sshd_config.gssapiauth }}"
        validate: sshd -t -f %s

- name: "MEDIUM | RHEL-09-255140 | PATCH | RHEL 9 SSH daemon must not allow Kerberos authentication."
  when:
    - rhel_09_255140
    - rhel9stig_sshd_required
  tags:
    - RHEL-09-255140
    - CAT2
    - CCI-001813
    - SRG-OS-000364-GPOS-00151
    - SRG-OS-000480-GPOS-00227
    - SV-258004r1045067_rule
    - V-258004
    - NIST800-53R4_CM-5
    - ssh
  notify: Restart_sshd
  block:
    - name: "MEDIUM | RHEL-09-255140 | PATCH | RHEL 9 SSH daemon must not allow Kerberos authentication. | Remove"
      when: "item.path != rhel9stig_sshd_config_file"
      ansible.builtin.replace:
        path: "{{ item }}"
        regexp: (?i)^(KerberosAuthentication (yes|true))
        replace: '#\1'
      failed_when: discovered_kerberosauth_exists.rc != 257
      register: discovered_kerberosauth_exists
      loop: "{{ prelim_sshd_config_files.files }}"

    - name: "MEDIUM | RHEL-09-255140 | PATCH | RHEL 9 SSH daemon must not allow Kerberos authentication. | Exists"
      ansible.builtin.lineinfile:
        path: "{{ rhel9stig_sshd_config_file }}"
        regexp: (?i)^(#|)\s*KerberosAuthentication\s*(yes|no|true|false)
        line: "KerberosAuthentication {{ rhel9stig_sshd_config.kerbauth }}"
        validate: sshd -t -f %s
- name: "MEDIUM | RHEL-09-255145 | PATCH | RHEL 9 SSH daemon must not allow rhosts authentication"
  when:
    - rhel_09_255145
    - rhel9stig_sshd_required
  tags:
    - RHEL-09-255145
    - CAT2
    - CCI-000366
    - SRG-OS-000480-GPOS-00227
    - SV-258005r1045069_rule
    - V-258005
    - NIST800-53R4_CM-6
    - ssh
  notify: Restart_sshd
  block:
    - name: "MEDIUM | RHEL-09-255145 | PATCH | RHEL 9 SSH daemon must not allow rhosts authentication | Remove"
      when: "item.path != rhel9stig_sshd_config_file"
      ansible.builtin.replace:
        path: "{{ item }}"
        regexp: (?i)^(IgnoreRhosts (no|false))
        replace: '#\1'
      failed_when: discovered_ignorerhosts_exists.rc != 257
      register: discovered_ignorerhosts_exists
      loop: "{{ prelim_sshd_config_files.files }}"

    - name: "MEDIUM | RHEL-09-255145 | PATCH | RHEL 9 SSH daemon must not allow rhosts authentication | Exists"
      ansible.builtin.lineinfile:
        path: "{{ rhel9stig_sshd_config_file }}"
        regexp: (?i)^(#|)\s*IgnoreRhosts\s*(yes|no|true|false)
        line: "IgnoreRhosts {{ rhel9stig_sshd_config.ignorerhosts }}"
        validate: sshd -t -f %s

- name: "MEDIUM | RHEL-09-255150 | PATCH | RHEL 9 SSH daemon must not allow known hosts authentication."
  when:
    - rhel_09_255150
    - rhel9stig_sshd_required
  tags:
    - RHEL-09-255150
    - CAT2
    - CCI-000366
    - SRG-OS-000480-GPOS-00227
    - SV-258006r991589_rule
    - V-258006
    - NIST800-53R4_CM-6
    - ssh
  notify: Restart_sshd
  block:
    - name: "MEDIUM | RHEL-09-255150 | PATCH | RHEL 9 SSH daemon must not allow known hosts authentication. | Remove"
      when: "item.path != rhel9stig_sshd_config_file"
      ansible.builtin.replace:
        path: "{{ item }}"
        regexp: (?i)^(IgnoreUserKnownHosts (no|false))
        replace: '#\1'
      failed_when: discovered_knownhosts_exists.rc != 257
      register: discovered_knownhosts_exists
      loop: "{{ prelim_sshd_config_files.files }}"

    - name: "MEDIUM | RHEL-09-255150 | PATCH | RHEL 9 SSH daemon must not allow known hosts authentication. | Exists"
      ansible.builtin.lineinfile:
        path: "{{ rhel9stig_sshd_config_file }}"
        regexp: (?i)^(#|)\s*IgnoreUserKnownHosts\s*(yes|no|true|false)
        line: "IgnoreUserKnownHosts {{ rhel9stig_sshd_config.ignoreknownhosts }}"
        create: true
        mode: 'go-rwx'
        validate: sshd -t -f %s

- name: "MEDIUM | RHEL-09-255155 | PATCH | RHEL 9 SSH daemon must disable remote X connections for interactive users."
  when:
    - rhel_09_255155
    - rhel9stig_sshd_required
  tags:
    - RHEL-09-255155
    - CAT2
    - CCI-000366
    - SRG-OS-000480-GPOS-00227
    - SV-258007r1045073_rule
    - V-258007
    - NIST800-53R4_CM-6
    - ssh
  notify: Restart_sshd
  block:
    - name: "MEDIUM | RHEL-09-255155 | PATCH | RHEL 9 SSH daemon must disable remote X connections for interactive users. | Remove"
      when: "item.path != rhel9stig_sshd_config_file"
      ansible.builtin.replace:
        path: "{{ item }}"
        regexp: (?i)(^X11Forwarding (yes|true))
        replace: '#\1'
      failed_when: discovered_x11forward_exists.rc != 257
      register: discovered_x11forward_exists
      loop: "{{ prelim_sshd_config_files.files }}"

    - name: "MEDIUM | RHEL-09-255155 | PATCH | RHEL 9 SSH daemon must disable remote X connections for interactive users. | Exists"
      ansible.builtin.lineinfile:
        path: "{{ rhel9stig_sshd_config_file }}"
        regexp: (?i)^(#|)\s*X11forwarding\s*(yes|no|true|false)
        line: "X11forwarding {{ rhel9stig_sshd_config.x11forward }}"
        create: true
        mode: 'go-rwx'
        validate: sshd -t -f %s

- name: "MEDIUM | RHEL-09-255160 | PATCH | RHEL 9 SSH daemon must perform strict mode checking of home directory configuration files."
  when:
    - rhel_09_255160
    - rhel9stig_sshd_required
  tags:
    - RHEL-09-255160
    - CAT2
    - CCI-000366
    - SRG-OS-000480-GPOS-00227
    - SV-258008r1045075_rule
    - V-258008
    - NIST800-53R4_CM-6
    - ssh
  notify: Restart_sshd
  block:
    - name: "MEDIUM | RHEL-09-255160 | PATCH | RHEL 9 SSH daemon must perform strict mode checking of home directory configuration files. | Remove"
      when: "item.path != rhel9stig_sshd_config_file"
      ansible.builtin.replace:
        path: "{{ item }}"
        regexp: (?i)^(StrictModes (no|false))
        replace: '#\1'
      failed_when: discovered_strictmode_exists.rc != 257
      register: discovered_strictmode_exists
      loop: "{{ prelim_sshd_config_files.files }}"

    - name: "MEDIUM | RHEL-09-255160 | PATCH | RHEL 9 SSH daemon must perform strict mode checking of home directory configuration files. | Exists"
      ansible.builtin.lineinfile:
        path: "{{ rhel9stig_sshd_config_file }}"
        regexp: (?i)^(#|)\s*StrictModes\s*(yes|no|true|false)
        line: "StrictModes {{ rhel9stig_sshd_config.strictmodes }}"
        create: true
        mode: 'go-rwx'
        validate: sshd -t -f %s

- name: "MEDIUM | RHEL-09-255165 | PATCH | RHEL 9 SSH daemon must display the date and time of the last successful account logon upon an SSH logon."
  when:
    - rhel_09_255165
    - rhel9stig_sshd_required
  tags:
    - RHEL-09-255165
    - CAT2
    - CCI-000366
    - SRG-OS-000480-GPOS-00227
    - SV-258009r1045077_rule
    - V-258009
    - NIST800-53R4_CM-6
    - ssh
  notify: Restart_sshd
  block:
    - name: "MEDIUM | RHEL-09-255165 | PATCH | RHEL 9 SSH daemon must display the date and time of the last successful account logon upon an SSH logon. | Remove"
      when: "item.path != rhel9stig_sshd_config_file"
      ansible.builtin.replace:
        path: "{{ item }}"
        regexp: (?i)^(PrintLastLog (no|false))
        replace: '#\1'
      failed_when: discovered_printlastlog_exists.rc != 257
      register: discovered_printlastlog_exists
      loop: "{{ prelim_sshd_config_files.files }}"

    - name: "MEDIUM | RHEL-09-255165 | PATCH | RHEL 9 SSH daemon must display the date and time of the last successful account logon upon an SSH logon. | Exists"
      ansible.builtin.lineinfile:
        path: "{{ rhel9stig_sshd_config_file }}"
        regexp: (?i)^(#|)\s*PrintLastLog\s*(yes|no|true|false)
        line: "PrintLastLog {{ rhel9stig_sshd_config.lastlog }}"
        create: true
        mode: 'go-rwx'
        validate: sshd -t -f %s

- name: "MEDIUM | RHEL-09-255175 | PATCH | RHEL 9 SSH daemon must prevent remote hosts from connecting to the proxy display."
  when:
    - rhel_09_255175
    - rhel9stig_sshd_required
  tags:
    - RHEL-09-255175
    - CAT2
    - CCI-000366
    - SRG-OS-000480-GPOS-00227
    - SV-258011r1045079_rule
    - V-258011
    - NIST800-53R4_CM-6
    - ssh
  notify: Restart_sshd
  block:
    - name: "MEDIUM | RHEL-09-255175 | PATCH | RHEL 9 SSH daemon must prevent remote hosts from connecting to the proxy display. | Remove"
      when: "item.path != rhel9stig_sshd_config_file"
      ansible.builtin.replace:
        path: "{{ item }}"
        regexp: (?i)^(X11UseLocalhost.*)
        replace: '#\1'
      failed_when: discovered_x11localhost_exists.rc != 257
      register: discovered_x11localhost_exists
      loop: "{{ prelim_sshd_config_files.files }}"

    - name: "MEDIUM | RHEL-09-255175 | PATCH | RHEL 9 SSH daemon must prevent remote hosts from connecting to the proxy display. | Exists"
      ansible.builtin.lineinfile:
        path: "{{ rhel9stig_sshd_config_file }}"
        regexp: (?i)^(#|)\s*X11UseLocalhost\s*(yes|no|true|false)
        line: "X11UseLocalhost {{ rhel9stig_sshd_config.x11uselocal }}"
        create: true
        mode: 'go-rwx'
        validate: sshd -t -f %s
